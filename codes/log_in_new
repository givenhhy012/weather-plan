# log_in.py
import pyrebase
from datetime import datetime

# Firebase 설정
firebase_config = {
    "apiKey": "AIzaSyDDoeGp8-kJrX68624sgfIkzscKO7aHg6k",
    "authDomain": "weather-plan.firebaseapp.com",
    "databaseURL": "https://weather-plan-default-rtdb.firebaseio.com/",
    "storageBucket": "weather-plan.firebasestorage.app"
}

firebase = pyrebase.initialize_app(firebase_config)
auth = firebase.auth()
db = firebase.database()

def sign_up(email, password):
    try:
        user = auth.create_user_with_email_and_password(email, password)
        user_id = user["localId"]
        token = user["idToken"]
        db.child("users").child(user_id).set({
            "email": email,
            "joined_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }, token=token)
        print("회원가입 및 정보 저장 성공")
        return user
    except Exception as e:
        print("회원가입 실패:", e)
        return None

def sign_in(email, password):    
    try:
        user = auth.sign_in_with_email_and_password(email, password)
        return user
    except Exception as e:
        print("로그인 실패:", e)
        return None

def save_schedule(user, title, date):
    try:
        user_id = user["localId"]
        token = user["idToken"]
        db.child("users").child(user_id).child("schedules").push(
            {"title": title, "date": date}, token=token
        )
        print("일정 저장 성공")
    except Exception as e:
        print("일정 저장 실패:", e)

def get_schedules_for_date(user, date_str):
    try:
        user_id = user["localId"]
        token = user["idToken"]
        schedules = db.child("users").child(user_id).child("schedules").get(token=token)
        result = []
        if schedules.each():
            for schedule in schedules.each():
                data = schedule.val()
                if data.get("date") == date_str:
                    result.append(data.get("title"))
        return result
    except Exception as e:
        print("일정 불러오기 실패:", e)
        return []

def save_outfit_record(user, outer, top, bottom, date_str):
    try:
        user_id = user["localId"]
        token = user["idToken"]
        db.child("users").child(user_id).child("outfit_records").push(
            {"date": date_str, "outer": outer, "top": top, "bottom": bottom}, token=token
        )
        print("옷차림 저장 성공")
    except Exception as e:
        print("옷차림 저장 실패:", e)
